From 3ea39caea3457b1e8f35d83f3a01136f1553b33e Mon Sep 17 00:00:00 2001
From: Lionel Landwerlin <lionel.g.landwerlin@intel.com>
Date: Mon, 17 Nov 2025 11:43:20 +0200
Subject: [PATCH] anv: ensure slab allocated memory matches image requirements
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The VMA of VkDeviceMemory has to accomodate all the resources that can
be bound to it. For sparse images it's 64KiB alignment, for other
tiled images it's 4KiB. But we also have a workaround that requires a
64KiB alignment for Tile4 images.

The initial version of the slab allocator missed the 4KiB alignment.
This fix adds the workaround handling too.

Signed-off-by: Lionel Landwerlin <lionel.g.landwerlin@intel.com>
Fixes: dabb012423 ("anv: Implement anv_slab_bo and enable memory pool")
Reviewed-by: Nanley Chery <nanley.g.chery@intel.com>
Reviewed-by: Jos√© Roberto de Souza <jose.souza@intel.com>
Part-of: <https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/38480>
(cherry picked from commit 401b2066b053ab4882d90a76628e3edfd70be936)
---
 .pick_status.json                |  2 +-
 src/intel/vulkan/anv_allocator.c | 15 ++++++++++++---
 src/intel/vulkan/anv_image.c     |  3 +++
 3 files changed, 16 insertions(+), 4 deletions(-)

diff --git a/.pick_status.json b/.pick_status.json
index 1d70dd9aef1ac..d203fd2977cab 100644
--- a/.pick_status.json
+++ b/.pick_status.json
@@ -1064,7 +1064,7 @@
         "description": "anv: ensure slab allocated memory matches image requirements",
         "nominated": true,
         "nomination_type": 2,
-        "resolution": 0,
+        "resolution": 1,
         "main_sha": null,
         "because_sha": "dabb012423dc27e2b03f13f7144406edacc89069",
         "notes": null
diff --git a/src/intel/vulkan/anv_allocator.c b/src/intel/vulkan/anv_allocator.c
index 9dce97126be06..95b1aeefa044a 100644
--- a/src/intel/vulkan/anv_allocator.c
+++ b/src/intel/vulkan/anv_allocator.c
@@ -1552,9 +1552,18 @@ anv_bo_vma_calc_alignment_requirement(struct anv_device *device,
    const bool is_small_heap = anv_bo_is_small_heap(alloc_flags);
    uint32_t align = 64; /* A cache line */
 
-   /* If it's big enough to store a tiled resource, we need 64K alignment */
-   if (size >= 64 * 1024 && !is_small_heap)
-      align = MAX2(64 * 1024, align);
+   /* If it's big enough to store a 64K tiled resource, we need 64K alignment.
+    * Wa_22015614752 requires that some images be aligned to 64k when used on
+    * multiple engines, so allocation that might contain 4k tiled images need
+    * to be aligned to 64k.
+    */
+   const uint64_t image_alignment =
+      (size >= 64 * 1024 ||
+       (device->queue_count > 1 &&
+        intel_needs_workaround(device->info, 22015614752))) ?
+      64 * 1024 : 4 * 1024;
+   if (size >= 4 * 1024 && !is_small_heap)
+      align = MAX2(image_alignment, align);
 
    /* If we're using the AUX map, make sure we follow the required
     * alignment.
diff --git a/src/intel/vulkan/anv_image.c b/src/intel/vulkan/anv_image.c
index 4342497b23bdc..3017e3b1575af 100644
--- a/src/intel/vulkan/anv_image.c
+++ b/src/intel/vulkan/anv_image.c
@@ -2926,6 +2926,9 @@ anv_image_bind_address(struct anv_device *device,
                         enum anv_image_memory_binding binding,
                         struct anv_address address)
 {
+   assert(anv_address_physical(address) %
+          image->bindings[binding].memory_range.alignment == 0);
+
    image->bindings[binding].address = address;
 
    /* Map bindings for images with host transfer usage, so that we don't have
-- 
GitLab

