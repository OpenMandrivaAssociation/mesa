From dc52f2e4386ce5e177b523c39681479df6363c0a Mon Sep 17 00:00:00 2001
From: David Rosca <david.rosca@amd.com>
Date: Mon, 17 Nov 2025 09:17:31 +0100
Subject: [PATCH] radv/video: Fix coding used_by_curr_pic_lt_flag

Fixes: d68a1fc0d43 ("radv/video: port hevc slice header encoding from radeonsi")
Closes: https://gitlab.freedesktop.org/mesa/mesa/-/issues/14301
Reviewed-by: Samuel Pitoiset <samuel.pitoiset@gmail.com>
Part-of: <https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/38475>
(cherry picked from commit 3abb2707e2dee5975fd453f2026c615d2a2d6f1a)
---
 .pick_status.json               | 2 +-
 src/amd/vulkan/radv_video_enc.c | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/.pick_status.json b/.pick_status.json
index d2e0bfb75a4ba..731cd297bf57f 100644
--- a/.pick_status.json
+++ b/.pick_status.json
@@ -374,7 +374,7 @@
         "description": "radv/video: Fix coding used_by_curr_pic_lt_flag",
         "nominated": true,
         "nomination_type": 2,
-        "resolution": 0,
+        "resolution": 1,
         "main_sha": null,
         "because_sha": "d68a1fc0d43546bc37906439b76ef5d8fbf2e5ee",
         "notes": null
diff --git a/src/amd/vulkan/radv_video_enc.c b/src/amd/vulkan/radv_video_enc.c
index 30e2a85fa563c..1fe65040048df 100644
--- a/src/amd/vulkan/radv_video_enc.c
+++ b/src/amd/vulkan/radv_video_enc.c
@@ -1203,7 +1203,7 @@ radv_enc_slice_header_hevc(struct radv_cmd_buffer *cmd_buffer, const VkVideoEnco
                                            util_logbase2_ceil(sps->num_long_term_ref_pics_sps));
             } else {
                radv_enc_code_fixed_bits(cmd_buffer, lt->poc_lsb_lt[i], sps->log2_max_pic_order_cnt_lsb_minus4 + 4);
-               radv_enc_code_fixed_bits(cmd_buffer, lt->used_by_curr_pic_lt_flag & (1 << i), 1);
+               radv_enc_code_fixed_bits(cmd_buffer, !!(lt->used_by_curr_pic_lt_flag & (1 << i)), 1);
                if (lt->used_by_curr_pic_lt_flag & (1 << i))
                   num_pic_total_curr++;
             }
-- 
GitLab

