From 87eb2b5e5932e519e92af84934550c6283ef26c3 Mon Sep 17 00:00:00 2001
From: Robert Beckett <bob.beckett@collabora.com>
Date: Wed, 5 Apr 2023 16:41:25 +0100
Subject: [PATCH] panfrost: create scanout kmsro buffer when shared

Signed-off-by: Robert Beckett <bob.beckett@collabora.com>
---
 src/gallium/drivers/panfrost/pan_resource.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/src/gallium/drivers/panfrost/pan_resource.c b/src/gallium/drivers/panfrost/pan_resource.c
index 727a509aa76..3d7c2006d0e 100644
--- a/src/gallium/drivers/panfrost/pan_resource.c
+++ b/src/gallium/drivers/panfrost/pan_resource.c
@@ -661,7 +661,12 @@ panfrost_resource_create_with_modifier(struct pipe_screen *screen,
                        : (bind & PIPE_BIND_SHADER_IMAGE)    ? "Shader image"
                                                             : "Other resource";
 
-   if (dev->ro && (template->bind & PIPE_BIND_SCANOUT)) {
+   /* Set up the "scanout resource". If the buffer might ever have
+    * resource_get_handle(WINSYS_HANDLE_TYPE_KMS) called on it.
+    * create_with_modifiers() doesn't give us usage flags, so we have to
+    * assume that all calls with PIPE_BIND_SHARED are scanout-possible.
+    */
+   if (dev->ro && (template->bind & PAN_BIND_SHARED_MASK)) {
       struct winsys_handle handle;
       struct pan_block_size blocksize =
          panfrost_block_size(modifier, template->format);
-- 
GitLab

