From cb75f652610ff6fb309270e91f33af18f11dd8fb Mon Sep 17 00:00:00 2001
From: Dave Airlie <airlied@redhat.com>
Date: Mon, 11 Sep 2023 13:42:28 +1000
Subject: [PATCH] nir: add deref follower builder for casts.

This fixes intel_clc builds with llvm 17 on
gfx125_bvh_build_DFS_DFS

where it dies in the lower indirect derefs pass.
---
 src/compiler/nir/nir_builder.h | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/src/compiler/nir/nir_builder.h b/src/compiler/nir/nir_builder.h
index c9f3465406c10..e777ec975d291 100644
--- a/src/compiler/nir/nir_builder.h
+++ b/src/compiler/nir/nir_builder.h
@@ -1570,6 +1570,9 @@ nir_build_deref_follower(nir_builder *b, nir_deref_instr *parent,
 
       return nir_build_deref_struct(b, parent, leader->strct.index);
 
+   case nir_deref_type_cast:
+      return nir_build_deref_cast(b, &parent->def, leader->modes,
+                                  leader->type, leader->cast.ptr_stride);
    default:
       unreachable("Invalid deref instruction type");
    }
-- 
GitLab

