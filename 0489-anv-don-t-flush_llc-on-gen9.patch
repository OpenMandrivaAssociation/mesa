From 960441d5a3f24b27a201da0c4ee8b26b91321ae9 Mon Sep 17 00:00:00 2001
From: Hyunjun Ko <zzoon@igalia.com>
Date: Tue, 17 Oct 2023 11:58:33 +0200
Subject: [PATCH 489/834] anv: don't flush_llc on gen9

Fixes: 3d993e63bb59 ("anv: Enable barrier handling on video engines ")
Closes: mesa/mesa#9988

Signed-off-by: Hyunjun Ko <zzoon@igalia.com>
Reviewed-by: Lionel Landwerlin <lionel.g.landwerlin@intel.com>
Part-of: <https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/25762>
---
 src/intel/vulkan/genX_cmd_buffer.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/src/intel/vulkan/genX_cmd_buffer.c b/src/intel/vulkan/genX_cmd_buffer.c
index a75fe633f2d..4a606e53c85 100644
--- a/src/intel/vulkan/genX_cmd_buffer.c
+++ b/src/intel/vulkan/genX_cmd_buffer.c
@@ -3982,7 +3982,13 @@ cmd_buffer_barrier_video(struct anv_cmd_buffer *cmd_buffer,
 #if GFX_VERx10 >= 125
          fd.FlushCCS = flush_ccs;
 #endif
+#if GFX_VER >= 12
+         /* Using this bit on Gfx9 triggers a GPU hang.
+          * This is undocumented behavior. Gfx12 seems fine.
+          * TODO: check Gfx11
+          */
          fd.FlushLLC = flush_llc;
+#endif
       }
    }
 }
-- 
2.42.0

